# Finance Gap Analysis

בדיקה שיטתית: האם המימוש הנוכחי תואם את החלטות החוזה  
`docs/FINANCE_DECISION_CONTRACT.md`

---

## 1. מקור האמת הפיננסי

**סטטוס: ⚠️ תואם חלקית**

המערכת מאפשרת יצירת מספר גיליונות הוצאות לאותו תיק (versionIndex 1, 2, 3...). `createFinancialExpenseSheet` לא בודק קיום גיליון פעיל — הוא רק מחשב versionIndex הבא. ב־buildReportHtml ל־PDF נבחר הגיליון האחרון לפי `updatedAt` — לא בהכרח הגיליון המקושר לדיווח. החישובים עצמם מגיעים מ־financialExpensesCalculator בלבד; expensesSum הוא legacy.

---

## 2. קדושת החישוב

**סטטוס: ✅ תואם**

כל חישוב הפיננסים החדש עובר דרך `financialExpensesCalculator.ts` ו־`calculateSheetTotals`. אין נוסחאות מקבילות במודול החדש. expensesSum ו־FinancialTracker משמשים רק לתצוגה legacy — לא משפיעים על חישובי גיליון הוצאות.

---

## 3. סגירת הוצאה

**סטטוס: ❌ לא תואם**

אחרי סימון "שולם" (`isPaid: true` בדיווח) אין חסימה על עריכת הגיליון. FinanceExpenseSheetEditor לא בודק `linkedReport?.isPaid` — איריס יכולה לפתוח, לערוך ולשמור גיליון גם כשהדיווח סומן שולם. הנעילה הקיימת (`getReportLockState`) מתייחסת לדיווח (firstSentAt, manualLock) ולא ל־isPaid. אין דרישה להערת ADMIN בעת שינוי לאחר שולם; ל־SUB_ADMIN/ADMIN יש confirm כשהגיליון ב־READY ומעלה, אך זה אזהרה בלבד ולא חסימה.

---

## 4. מחיקה של גיליון הוצאות

**סטטוס: ❌ לא תואם**

`deleteFinancialExpenseSheet` מוחק גיליון בלי לבדוק קישור לדיווח או סטטוס שולם. FinanceExpensesDashboard מציג כפתור מחיקה לכל גיליון, עם confirm בלבד. אין בדיקה אם הגיליון משויך לדיווח, אם הדיווח שולם, או אם המשתמש הוא ADMIN. אין תיעוד מחיקה.

---

## 5. חיבור דיווח ↔ פיננסים

**סטטוס: ⚠️ תואם חלקית**

הדיווח שומר `expensesSheetId` ו־`expensesHtml`, אך buildReportHtml ל־PDF לא משתמש בהם. ה־PDF נבנה מהגיליון העדכני ביותר בתיק (לפי updatedAt) דרך `buildCumulativeExpensesSnapshot` — כלומר לינק חי ולא snapshot. שינוי בגיליון אחרי שליחת הדיווח ישפיע על PDF חדש. הזרימה העסקית (איריס מכינה → עורכת הדין משלימה) תואמת את החוזה.

---

## 6. חד־משתמשי

**סטטוס: ✅ תואם**

אין לוגיקת נעילות, אין פתרון קונפליקטים, אין הנחות על עבודה מקבילית. FinanceExpenseSheetEditor מיועד למשתמשת אחת. SUB_ADMIN/ADMIN יכולים להיכנס כמשתמשים חריגים — ללא מנגנון ייעודי.

---

## 7. Legacy

**סטטוס: ⚠️ תואם חלקית**

FinancialTracker משתמש ב־`expensesSum` ו־`isPaid` — מודל ישן. handleFinanceTaskCreate יוצר דיווחים עם expenseWorksheet ו־expensesSum — זרימה legacy שעדיין פעילה. הזרימה החדשה (handleNotifyLawyerFromFinance, expensesSheetId) קיימת במקביל. אין שימוש ב־expensesSum כבסיס לפיצ'רים חדשים במודול הפיננסי — אך הוא עדיין משמש לתצוגה ולזרימה ישנה.

---

## Executive Summary

| סטטוס | כמות | סעיפים |
|-------|------|--------|
| ✅ תואם | 2 | קדושת חישוב, חד־משתמשי |
| ⚠️ תואם חלקית | 3 | מקור אמת, חיבור דיווח–פיננסים, Legacy |
| ❌ לא תואם | 2 | סגירת הוצאה, מחיקת גיליון |

### אזורי סיכון עיקריים

1. **עריכה לאחר "שולם"** — איריס יכולה לשנות גיליון גם כשהדיווח סומן שולם; אין חסימה ואין תיעוד שינוי.
2. **מחיקה ללא הגנה** — ניתן למחוק גיליון מקושר לדיווח ששולם, ללא בדיקת הרשאה וללא תיעוד.
3. **מספר גיליונות ותזמון PDF** — המערכת מאפשרת גיליונות מרובים לתיק וב־PDF משתמשת בגיליון האחרון לפי זמן — לא בגיליון המקושר לדיווח.
