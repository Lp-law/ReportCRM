# אבחון זרימת הוצאות, דיווחים ו־Snapshot

השוואה בין התהליך העסקי בפועל של המשרד לבין המימוש הנוכחי של המערכת.
מסמך אבחון בלבד — ללא הצעות פתרון, ללא TODO.

---

## Executive Summary

הדיווח שומר קישור לגיליון (`expensesSheetId`) וטקסט HTML של טבלת ההוצאות (`expensesHtml`) — שהוא snapshot בזמן החיבור. ה־PDF נבנה מ־`report.expensesHtml` שמגיע ב־payload, כלומר מהנתונים השמורים בדיווח. עם זאת, קיימת migration שמשלימה `expensesHtml` חסר באמצעות `buildCumulativeExpensesSnapshot` על הגיליון הנוכחי — כלומר נתונים "חיים" — מה שעלול להכניס ערכים מעודכנים לדיווח ישן. אין snapshot מבני (שורות/סכומים בנפרד); רק HTML. תיקון בדיעבד בגיליון לא משנה את הדיווח או את ה־PDF שכבר נוצר — אך PDF חדש שיורד אחרי העריכה עדיין ישתמש ב־expensesHtml הישן ששמור בדיווח, אלא אם Migration דרס אותו.

---

## 1. מבנה נוכחי

### האם הדיווח שואב נתונים מגיליון "חי"?

**בזרימת PDF (שרת):** לא. ה־PDF נבנה ב־server.js על בסיס `buildSectionsData(report)`. סעיף ההוצאות משתמש ב־`report.expensesHtml` כאשר הוא קיים — כלומר בנתונים השמורים באובייקט הדיווח, לא בקריאה לגיליון.

**בתצוגת מקדימה (UI):** הטבלה במסך הדיווח מציגה את `expensesHtml` השמור בדיווח. אין קריאה live לגיליון בעת הצגת הדיווח.

### האם קיימת הפרדה בין נתונים לדיווח לבין נתונים דינמיים?

**כן, חלקית.** הדיווח שומר:
- `expensesSheetId` — קישור לגיליון
- `expensesHtml` — HTML של הטבלה (snapshot)
- `expensesSnapshotAt` — timestamp למועד ה־snapshot

הגיליון עצמו נשאר דינמי: איריס יכולה לערוך שורות, להוסיף נספחים ולשנות סטטוסים. השינויים הללו לא מעדכנים אוטומטית את `expensesHtml` בדיווח.

**חוסר הפרדה:** קיימת migration שמזהה דיווחים עם `expensesSheetId` אבל בלי `expensesHtml`, ובונה HTML חדש מ־`buildCumulativeExpensesSnapshot(sheetId, new Date().toISOString())` — כלומר מנתונים נוכחיים. במצב זה הדיווח מקבל snapshot "חי" בניגוד לכוונה של snapshot בזמן החיבור.

---

## 2. נקודות בזמן

### באיזה שלב הנתונים "נתפסים" לדיווח?

1. **כשאיריס לוחצת "נשלח לעו״ד"** (`handleNotifyLawyerFromFinance`):  
   נבנה `buildCumulativeExpensesSnapshot` + `renderExpensesTableHtml`, והתוצאה נשמרת ב־`expensesHtml`, `expensesSnapshotAt`.

2. **כשעורכת הדין לוחצת "הוסף טבלת הוצאות"** (`insertWorksheetIntoSection`):  
   אותו תהליך — snapshot מהגיליון באותו רגע נשמר ב־`expensesHtml`, `expensesSnapshotAt`.

3. **Migration (רקע):**  
   דיווחים עם `expensesSheetId` אך בלי `expensesHtml` מקבלים HTML חדש שנבנה מאותו רגע — לא מאותו זמן חיבור.

### האם שליחת דיווח / שליחה לליאור / סימון שולם משנים משהו?

- **שליחת דיווח (SENT):** לא משנה את `expensesHtml` או את הקישור לגיליון.
- **שליחה לליאור:** לא משנה.
- **סימון "שולם":** מעדכן `isPaid` בדיווח בלבד. אין נעילה על עריכת הגיליון ואין עדכון של `expensesHtml`.

הנתונים בדיווח (כולל `expensesHtml`) נשארים כפי שהיו ברגע החיבור, מלבד מקרה ה־migration.

---

## 3. שינוי בדיעבד

### אם איריס עורכת הוצאה אחרי שדיווח נשלח

**הדיווח הישן:** לא משתנה. `expensesHtml` נשאר כמו ששמור.

**PDF ישן:** קובץ PDF שכבר נוצר והורד — לא משתנה. הוא קובץ סטטי.

**PDF חדש (הורדה חוזרת):** נבנה מ־`report.expensesHtml` שב־payload. אם הדיווח לא דרס על־ידי migration — ה־PDF יציג את הטבלה הישנה. אם migration ריצה ודרס `expensesHtml` — ה־PDF יציג נתונים מעודכנים (חיים), בניגוד לתמונה בזמן השליחה.

**הבחנה:** אין במערכת מנגנון שמבדיל במפורש בין "דיווח שננעל" ל"דיווח פתוח לעדכון". ה־snapshot נשמר אך יכול להידרס על־ידי migration.

---

## 4. התאמה לתהליך העסקי

### איפה המערכת תואמת

- **איריס מכינה → עו״ד משלימה:** הגיליון נוצר ב־Finance, נשלח לעו״ד, הדיווח מקבל snapshot באותו רגע. זרימת העבודה תואמת.
- **טבלה פתוחה מבחינת איריס:** הגיליון נשאר דינמי; איריס יכולה לערוך גם אחרי שדיווח נשלח.
- **הצגת היסטוריה:** `buildCumulativeExpensesSnapshot` מחשב היסטוריה מגיליונות קודמים (historicalLines) ותשלומים — תואם לדרישה להציג "מה שולם בעבר", "מה חדש".

### איפה המערכת מחמירה מדי

- אין במקום הנוכחי חסימה מפורשת — הדרישה הייתה לאפשר לאיריס לתקן. ההתנהגות הנוכחית מאפשרת עריכה.

### איפה המערכת רכה מדי / לא ברורה

- **Migration:** מזריק snapshot "חי" לדיווחים ישנים שחסר להם `expensesHtml`, בלי להבדיל בין דיווח שנשלח לדיווח בטיוטה. התוצאה: דיווח שנשלח בעבר עלול לקבל טבלה מעודכנת.
- **חוסר snapshot מבני:** יש רק HTML. אין שמירת שורות/סכומים בנפרד, מה שמקשה על אימות, השוואה או שחזור מדויק.
- **עריכה לאחר "שולם":** אין חסימה על עריכת הגיליון אחרי סימון שולם — בניגוד לחוזה שמבקש חסימה למשתמש רגיל.

---

## 5. Snapshot — הבנה נוכחית

### האם קיים מנגנון Snapshot?

**כן, חלקי.**  
- `expensesHtml` — snapshot טקסטואלי (HTML) של טבלת ההוצאות.  
- `expensesSnapshotAt` — timestamp.  
- ה־UI מציג: "Based on the latest Expenses Table as of {expensesSnapshotAt}".

אין snapshot מבני (מערך שורות, סכומים, metadata נפרדים).

### האם המערכת מתנהגת כ־Live Data מלא?

לא. ה־PDF משתמש ב־`expensesHtml` השמור בדיווח. התצוגה בדיווח משתמשת באותו שדה. החלק היחיד שמכניס live data הוא ה־migration שמשלים `expensesHtml` חסר.

### נקודות שבהן Snapshot יכול לשבור את זרימת איריס

- **אם Snapshot יהיה "קשיח" מדי:** איריס צריכה לתקן טעויות גם אחרי שהעבירה לעו״ד. נעילה מוחלטת על הגיליון אחרי חיבור תפגע ביכולת לתקן.
- **החלפת expensesHtml בדיווח קיים:** אם snapshot יוגדר כ"קדוש" ולא ישתנה — migration לא אמור לדרוס דיווחים שיש להם כבר `expensesHtml`.
- **גיליון חדש במקום תיקון:** אם איריס תצטרך ליצור גיליון חדש (גרסה חדשה) במקום לערוך את הקיים — הזרימה תסתבך; היום היא יכולה לערוך את הגיליון הקיים.

---

## 6. מצבים חריגים — תיקון בדיעבד

התהליך העסקי דורש שאחרי שליחת איריס → עו״ד → ליאור → חברת הביטוח, תהיה לאיריס אפשרות לתקן את טבלת ההוצאות.

**מה קורה היום:**  
איריס יכולה לערוך את הגיליון. השינויים לא מעדכנים את `expensesHtml` בדיווח שכבר מקושר.  
- דיווח ישן: ממשיך להציג את הטבלה כפי שהייתה.  
- PDF חדש: יציג את הטבלה הישנה (אלא אם migration דרס).  
- גיליון: מעודכן; בדיווחים עתידיים יוצגו הנתונים המעודכנים.

**המסקנה:**  
המערכת מאפשרת תיקון בגיליון, אך אין עדכון אוטומטי של הדיווחים שכבר נשלחו. התיקון ישפיע על דיווחים עתידיים ומצב הגיליון הנוכחי, לא על הדיווחים שכבר יצאו.

---

## 7. סיכום — זהירות לפני קיבוע Snapshot

### מה ברור

- הדיווח שומר `expensesSheetId`, `expensesHtml`, `expensesSnapshotAt`.
- ה־PDF משתמש ב־`expensesHtml` מה־payload.
- אין snapshot מבני מלבד HTML.
- Migration משלים `expensesHtml` חסר עם נתונים חיים — סיכון לדריסת snapshot בדיווחים ישנים.

### מה דורש זהירות

1. **Migration:** יש להבחין בין דיווח שנשלח (SENT) לדיווח בטיוטה לפני השלמת `expensesHtml` מ־live data.
2. **נקודת נעילה:** אם יוגדר snapshot "סופי" — צריך להחליט באיזה שלב (שליחה לליאור? סימון שולם?) ולא לפגוע ביכולת איריס לתקן טעויות.
3. **תיקון בדיעבד:** אם snapshot יהיה קשיח — יש להגדיר מפורש איך איריס מתקנת: גיליון חדש? override ל־ADMIN? שמירה על שני מצבים (נשלח vs מתוקן)?

### איפה לא ברור

- האם `src/pdf/buildReportHtml.ts` (client-side) משמש במקום כלשהו; הוא בונה מ־live data ולא מ־`expensesHtml`.
- האם יש דרישה שמסמך PDF שכבר נשלח יישאר זהה תמיד, או שמותר ל"הוריד PDF מחדש" עם נתונים מעודכנים.
